---
// src/pages/admin/editar-player.astro
import { checkAdminAuth } from "../../../lib/authAdmin.js";
import { query } from "../../../lib/db.js";

// 1. Guardia de seguridad
checkAdminAuth(Astro);

// 2. Obtener el ID del jugador de la URL (reemplaza $_GET['id'])
const id = Astro.url.searchParams.get("id");
if (!id) {
    return Astro.redirect("/admin/players");
}

interface Player {
    id: number;
    name: string;
    position: string;
    isMVP: boolean;
    skill_dribbling: number;
    skill_pase: number;
    skill_lanzamiento: number;
    teamAchievements: string;
}

// 4. Lógica GET (obtener datos para rellenar el formulario)
const sql = "SELECT * FROM players WHERE id = ?";

// 5. Usamos 'as Player[]' y LUEGO desestructuramos el primer elemento
const [player] = (await query({ query: sql, values: [id] })) as Player[];

if (!player) {
    return new Response("Jugador no encontrado.", { status: 404 });
}

// 4. Preparar datos para el formulario
const achievements_string = JSON.parse(player.teamAchievements || "[]").join(
    ", ",
);
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <title>Editar Jugador</title>
        <style>
            body {
                font-family: Arial, sans-serif; /* ... */
            }
        </style>
    </head>
    <body>
        <h1>Editar Jugador: {player.name}</h1>

        <form action="/api/admin/editar-player" method="post">
            <input type="hidden" name="id" value={player.id} />

            <div class="form-group">
                <label for="name">Nombre:</label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    value={player.name}
                    required
                />
            </div>
            <div class="form-group">
                <label for="position">Posición:</label>
                <input
                    type="text"
                    id="position"
                    name="position"
                    value={player.position}
                    required
                />
            </div>

            <div class="form-group">
                <label for="teamAchievements"
                    >Logros (separados por comas):</label
                >
                <textarea id="teamAchievements" name="teamAchievements"
                    >{achievements_string}</textarea
                >
            </div>

            <div class="form-group checkbox-group">
                <input
                    type="checkbox"
                    id="isMVP"
                    name="isMVP"
                    checked={player.isMVP}
                />
                <label for="isMVP">¿Es MVP del Mes?</label>
            </div>

            <button type="submit">Guardar Cambios</button>
        </form>

        <br />
        <a href="/admin/players">Cancelar y volver a la lista</a>
    </body>
</html>
